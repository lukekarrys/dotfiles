#!/usr/bin/env bash

if [ -z "$TRANSCODE_BATCH_WORK_DIR" ]; then
    echo "export \$TRANSCODE_BATCH_WORK_DIR must be set"
    exit 1
fi

readonly work="$TRANSCODE_BATCH_WORK_DIR"
readonly queue="$work/queue"
readonly crops="$work/crops"

readonly original="$1"
readonly filename="$(basename "${original%.*}")"
readonly cmd="$2"
readonly option="$3"

usage(){
    echo "Usage:"
    echo ""
    echo "Start batch transcoding: $0"
    echo ""
    echo "Add file to batch queue: $0 \$file queue"
    echo ""
    echo "Add crop value for file: $0 \$file crop 140:140:0:0"
    echo ""
    exit 1
}

error(){
    echo "Error: $1"
    echo ""
}

if [ ! -z "$filename" ] && [ ! -f "$original" ]; then
    error "$filename must exist"
    usage
fi

if [ ! -z "$filename" ] && [ -z "$cmd" ]; then
    error "If passing in a file, a command must also be used"
    usage
fi

if [ "$cmd" == "queue" ]; then
    echo "$filename" >> $queue
    exit 0
elif [ "$cmd" == "crop" ]; then
    if [ -z "$option" ]; then
        error "Crop requires a value"
        usage
    fi
    echo "$3" > "$crops/$filename"
    exit 0
fi

input="$(sed -n 1p "$queue")"

while [ "$input" ]; do
    title_name="$(basename "$input" | sed 's/\.[^.]*$//')"
    crop_file="$crops/${title_name}"

    if [ -f "$crop_file" ]; then
        crop_option="--crop $(cat "$crop_file")"
    else
        crop_option=''
    fi

    sed -i '' 1d "$queue" || exit 1

    transcode-video --abr --target big --quick --output "output/" $crop_option "originals/${input}.mkv"

    input="$(sed -n 1p "$queue")"
done